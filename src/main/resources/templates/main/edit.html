<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
   <body data-spy="scroll" data-target=".navbar" data-offset="60">
      <div class="hk-wrapper">
         <div class="hk-pg-wrapper px-0" style="padding-top:0px;">
            <div class="container-fluid">
               <!-- Row -->
               <div class="row">
                  <div class="col-xl-12 pa-0">
                     <div class="bg-white shadow-bottom">
                        <div class="container" style="max-width:1600px;">
                           <ul class="nav nav-light nav-tabs" role="tablist" id="menu-tab">
                              <li class="nav-item">
                                 <a class="d-flex h-60p align-items-center nav-link" th:onclick="'switchContent(\'/forum/main/content?id=' + ${forum.idx} + '\')'" style="cursor:pointer;">게시물 정보</a>
                              </li>
                              <li class="nav-item">
                                 <a class="d-flex h-60p align-items-center nav-link" th:onclick="'switchContent(\'/forum/main/history?id=' + ${forum.idx} + '\')'" style="cursor:pointer;">게시물 이력</a>
                              </li>
                              <li class="nav-item">
                                 <a class="d-flex h-60p align-items-center nav-link" th:onclick="'switchContent(\'/forum/main/profile?id=' + ${forum.user.idx} + '\')'" style="cursor:pointer;">게시자 정보</a>
                              </li>
                              <li class="nav-item">
                                 <a class="d-flex h-60p align-items-center nav-link active" th:onclick="'switchContent(\'/forum/main/edit?id=' + ${forum.idx} + '\')'" style="cursor:pointer;">수정요청</a>
                              </li>
                           </ul>
                        </div>
                     </div>
                     <div class="tab-content mt-sm-60 mt-30">
                        <div class="tab-pane fade show active" role="tabpanel">
                           <div class="container"  style="max-width:1600px;">
                              <div class="hk-row">
                                <div class="col-xl-12 pa-0">
                                   <div class="tab-content sm-60">
                                      <div class="tab-pane fade show active" role="tabpanel">
                                         <div class="container"  style="max-width:1600px;">
                                            <div class="hk-row">
                                               <div class="col-lg-6" >
                                                  <div class="card-columns card-column-1" style="margin-bottom:10px;">
                                                     <div class="card card-profile-feed mb-0 rounded-bottom-0">
                                                        <div class="emailapp-wrap">
                                                           <div class="email-box" style="margin-left:0px;">

                                                              <div class="emailapp-right" style="min-width:100%; flex:none; right:0%; position:unset;">
                                                                 <div class="email-body">
                                                                    <div class="slimScrollDiv" style="position: relative; overflow: hidden; width: auto; height: 100%;">
                                                                       <div class="nicescroll-bar" tabindex="-50" style="overflow: hidden; width: auto; height: 100%; outline: none;">
                                                                          <div>
                                                                             <div class="email-subject-head" >
                                                                                <h4 th:text="${forum.title}"></h4>
                                                                                <div class="d-flex align-items-center" style="margin-bottom:0px;">
                                                                                   <span class="badge badge-secondary mr-10" th:each="subjects : ${forum.subjects}" th:text="${subjects.subject.name}"></span>
                                                                                </div>
                                                                             </div>
                                                                             <hr class="mt-10 mb-20">
                                                                             <div class="email-head">
                                                                                <div class="media">
                                                                                   <div class="media-img-wrap">
                                                                                      <div class="avatar">
                                                                                         <img th:src="@{${forum.user.image_url} != null ? '/forum/img?id=' + ${forum.user.image_url} : '/dist/img/img-thumb.jpg'} "
                                                                                            alt="user" class="avatar-img rounded-circle">
                                                                                      </div>
                                                                                   </div>
                                                                                   <div class="media-body">
                                                                                      <span class="text-capitalize sender-name d-inline-block" th:text="${forum.user.nickname}"></span>
                                                                                      <span class="sender-email d-inline-block" th:text="'(' + ${forum.user.username} + ')'"></span>
                                                                                      <span class="d-block">

                                                                                        <span th:text="${forum.user.email} == null ? '이메일 미등록' : ${forum.user.email}"></span>
                                                                                      </span>
                                                                                   </div>
                                                                                </div>
                                                                                <div class="head-other-wrap">
                                                                                   <div class="d-inline-block mr-5">
                                                                                      <span class="d-inline-block" th:text="${#temporals.format(forum.update_date, 'yyyy/MM/dd HH:mm')}"></span>
                                                                                   </div>
                                                                                </div>
                                                                             </div>
                                                                             <div class="email-text-wrap mt-30">
                                                                                <p class="mb-40" th:text="${forum.content}"></p>
                                                                                <div class="d-flex flex-wrap">
                                                                                 <a class="w-sm-150p w-80p mr-10 mb-10" th:each="files,num : ${forum.files}">
                                                                                   <img class="img-fluid rounded"
                                                                                        th:if="${num.index < 6}"
                                                                                        th:src="'/forum/img?id=' + ${files.file_url}"
                                                                                        alt="Card image cap"
                                                                                        style="max-width:150px;">
                                                                                 </a>
                                                                               </div>
                                                                             </div>
                                                                             <hr class="hr-light">
                                                                             <div class="email-attachment-wrap" th:if="${#lists.size(forum.files)} > 0">
                                                                                <div class="email-attachment-block">
                                                                                   <a href="javascript:void(0)" th:each="files,num : ${forum.files}">
                                                                                      <div class="card card-sm w-200p">
                                                                                         <div class="card-body d-flex align-items-center">
                                                                                            <img src="/dist/img/jpgicon.png" class="d-inline-block mr-10" alt="attachicon">
                                                                                            <span class="d-inline-block mnw-0">
                                                                                            <span class="d-block file-name text-truncate">concept_design.jpg</span>
                                                                                            <small class="d-block file-size text-truncate">5.78 MB</small>
                                                                                            </span>
                                                                                         </div>
                                                                                      </div>
                                                                                   </a>
                                                                                </div>
                                                                                <div class="d-flex ml-auto">
                                                                                   <a href="javascript:void(0)"><i class="zmdi zmdi-download"></i></a>
                                                                                </div>
                                                                             </div>
                                                                          </div>
                                                                       </div>
                                                                    </div>
                                                                 </div>
                                                              </div>
                                                           </div>
                                                        </div>
                                                        <div class="card-footer justify-content-between">
                                                           <div>
                                                              <a href="#"><i class="ion ion-md-heart text-primary"></i><span th:text="${forum.recommendedCount}"></span></a>
                                                           </div>
                                                        </div>
                                                     </div>
                                                  </div>
                                               </div>


                                               <!-- 수정글 -->
                                               <div class="col-lg-6" >
                                                  <div class="card-columns card-column-1" style="margin-bottom:10px;">
                                                     <div class="card card-profile-feed mb-0 rounded-bottom-0">
                                                        <div class="emailapp-wrap">
                                                           <div class="email-box" style="margin-left:0px;">
                                                              <div class="emailapp-right" style="min-width:100%; flex:none; right:0%; position:unset;">
                                                                 <div class="email-body">
                                                                    <div class="slimScrollDiv" style="position: relative; overflow: hidden; width: auto; height: 100%;">
                                                                       <div class="nicescroll-bar" tabindex="-50" style="overflow: hidden; width: auto; height: 100%; outline: none;">
                                                                          <div>
                                                                             <div class="email-subject-head" >
                                                                                <input type="text" class="form-control" name="title" th:value="${forum.title}" style="background:#fff;">
                                                                                <div class="d-flex align-items-center" style="margin-bottom:0px;" id="subjects-list">
                                                                                   <span class="badge badge-secondary ml-10" th:each="subjects : ${forum.subjects}" th:text="${subjects.subject.name}" th:data-id="${subjects.idx}"></span>
                                                                                </div>
                                                                             </div>
                                                                             <hr class="mt-10 mb-20">
                                                                             <div class="email-head">
                                                                                <div class="media">
                                                                                   <div class="media-img-wrap">
                                                                                      <div class="avatar">
                                                                                         <img th:src="@{${session.ForumUserSession?.image_url} != null ? '/forum/img?id=' + ${session.ForumUserSession?.image_url} : '/dist/img/img-thumb.jpg'} "
                                                                                            alt="user" class="avatar-img rounded-circle">
                                                                                      </div>
                                                                                   </div>
                                                                                   <div class="media-body">
                                                                                      <span class="text-capitalize sender-name d-inline-block" th:text="${session.ForumUserSession.nickname}"></span>
                                                                                      <span class="sender-email d-inline-block" th:text="'(' + ${session.ForumUserSession.username} + ')'"></span>
                                                                                      <span class="d-block">

                                                                                        <span th:text="${session.ForumUserSession.email} == null ? '이메일 미등록' : ${session.ForumUserSession.email}"></span>
                                                                                      </span>
                                                                                   </div>
                                                                                </div>
                                                                                <div class="head-other-wrap">
                                                                                   <div class="d-inline-block mr-5">
                                                                                      <span class="d-inline-block"></span>
                                                                                   </div>
                                                                                </div>
                                                                             </div>
                                                                             <div class="email-text-wrap mt-30">
                                                                                <textarea class="form-control" aria-label="With textarea" style="min-height:300px;" name="content" th:text="${forum.content}"></textarea>
                                                                             </div>
                                                                             <hr class="hr-light">
                                                                             <div class="email-attachment-wrap" th:if="${#lists.size(forum.files)} > 0">
                                                                                <div class="email-attachment-block" id="files-list">
                                                                                   <a th:each="files,num : ${forum.files}"  th:id="'file-index-' + ${num.index}" th:data-id="${files.idx}">
                                                                                      <div class="card card-sm w-200p">
                                                                                         <div class="card-body d-flex align-items-center">
                                                                                           <button type="button" class="close" style="position:absolute; right:0; top:0;"  th:onclick="'removeFile(' + ${num.index} +')'">
                                                                                                <span aria-hidden="true" style="font-size:15px;">×</span>
                                                                                            </button>
                                                                                            <img src="/dist/img/jpgicon.png" class="d-inline-block mr-10" alt="attachicon">
                                                                                            <span class="d-inline-block mnw-0">
                                                                                              <span class="d-block file-name text-truncate" th:text="${files.name}"></span>
                                                                                              <small class="d-block file-size text-truncate" th:text="${files.file_size} + ' byte'"></small>
                                                                                            </span>
                                                                                         </div>
                                                                                      </div>
                                                                                   </a>
                                                                                </div>
                                                                                <div class="d-flex ml-auto">
                                                                                   <a href="javascript:void(0)"><i class="zmdi zmdi-download"></i></a>
                                                                                </div>
                                                                             </div>
                                                                             <hr class="hr-light">
                                                                               <section class="hk-sec-wrapper">
                                                                                    <div class="card-body" style="padding:0px; margin:30px 0px 10px 0px;">
                                                                                       <i class="glyphicon glyphicon-search"></i>
                                                                                       첨부파일을 업로드 할수 있습니다 (최대 5개)
                                                                                    </div>
                                                                                 <div  class="row">
                                                                                    <input type="file" class="dropify" id="uploadFiles" multiple/>
                                                                                 </div>
                                                                               </section>
                                                                               <button type="button" class="btn btn-success" style="margin:15px 0px 15px 0px; float:right;" onclick="submit()">등록하기</button>
                                                                          </div>
                                                                       </div>
                                                                    </div>
                                                                 </div>
                                                              </div>
                                                           </div>
                                                        </div>
                                                     </div>
                                                  </div>
                                               </div>

                                            </div>
                                         </div>
                                      </div>
                                   </div>
                                </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
               <!-- /Row -->
            </div>
         </div>
      </div>
      <script th:src="@{/vendors/dropzone/dist/dropzone.js}"></script>
      <!-- Dropify JavaScript -->
      <script th:src="@{/vendors/dropify/dist/js/dropify.min.js}"></script>
      <!-- Form Flie Upload Data JavaScript -->
      <script th:src="@{/dist/js/form-file-upload-data.js}"></script>

      <script>
        function submit(){
          var formData = new FormData();
          var title = $("input[name=title]").val();
          var content = $("textarea[name=content]").val();
          var origin_files = $("#files-list").children();
          var files = document.getElementById('uploadFiles').files;
          var subjects = $("#subjects-list").children();

          for(var idx=0; idx<origin_files.length; idx++){
            formData.append("file_idx",origin_files[idx].dataset.id);
          }
          for(var idx=0; idx<files.length; idx++){
            formData.append("files",files[idx]);
          }
          for(var idx=0; idx<subjects.length; idx++){
            formData.append("subject",subjects[idx].dataset.id);
          }
          formData.append("title", title);
          formData.append("content", content);
          formData.append("modify_parent_idx","[[${forum.idx}]]");

          postAPI("/forum/main/edit",formData, function(result){
             switch(result){
               case "ok":
                 alert("변경이 요청되었습니다.");
                 location.href="/forum/main"
                 break;
               case "error" :
                 alert("오류가 발생하였습니다.");
                break;
             }
           });
        }

        function removeFile(index){
          $("#file-index-"+index).remove();
        }
      </script>
   </body>
</html>
